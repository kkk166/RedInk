# å·¥ä½œæµåç§°
name: Master Build and Push Docker Image

# è§¦å‘äº‹ä»¶ï¼Œå½“å‘masteråˆ†æ”¯æ¨é€ä»£ç ï¼Œæˆ–è€…æ¨é€æ ‡ç­¾åä»¥vå¼€å¤´çš„æ ‡ç­¾æ—¶è§¦å‘å·¥ä½œæµ
on:
  push:
    branches: [master, dev]
    tags:
      - "v*"
  workflow_dispatch:

env:
  # å®¹å™¨æ³¨å†Œè¡¨ï¼Œè¿™é‡Œä½¿ç”¨GitHub Container Registryï¼ˆghcr.ioï¼‰
  REGISTRY: ghcr.io
  # é•œåƒåç§°ï¼Œä½¿ç”¨GitHubä»“åº“çš„å…¨å
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push:
    name: æ„å»ºå¹¶æ¨é€
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write
    steps:
      - name: æ‹‰å–ä»£ç 
        uses: actions/checkout@v4

      - name: å‡†å¤‡ QEMUï¼ˆå¤šæ¶æ„ï¼‰
        uses: docker/setup-qemu-action@v3

      - name: å¯ç”¨ Buildx
        uses: docker/setup-buildx-action@v3

      - name: ç™»å½• GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ç™»å½• Docker Hubï¼ˆå¯é€‰ï¼‰
        if: ${{ secrets.DOCKERHUB_USERNAME != '' && secrets.DOCKERHUB_TOKEN != '' }}
        uses: docker/login-action@v3
        with:
          registry: docker.io
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ç”Ÿæˆé•œåƒæ ‡ç­¾ä¸å…ƒæ•°æ®
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
            ${{ secrets.DOCKERHUB_USERNAME != '' && format('docker.io/{0}/redink', secrets.DOCKERHUB_USERNAME) || '' }}
          tags: |
            type=ref,event=branch
            type=ref,event=tag
            type=sha,prefix=sha-
            type=raw,value=latest,enable={{is_default_branch}}
          labels: |
            org.opencontainers.image.title=RedInk
            org.opencontainers.image.description=RedInk-å°çº¢ä¹¦AIå›¾æ–‡ç”Ÿæˆå™¨

      - name: æ„å»ºå¹¶æ¨é€é•œåƒï¼ˆå¼€å¯ç¼“å­˜ï¼‰
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          pull: true
          platforms: linux/amd64,linux/arm64
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILDKIT_INLINE_CACHE=1
      
      - name: è¾“å‡ºé•œåƒä¿¡æ¯
        run: |
          echo "ğŸ‰ Docker é•œåƒæ„å»ºæˆåŠŸï¼"
          echo "é•œåƒæ ‡ç­¾ï¼š"
          echo "${{ steps.meta.outputs.tags }}"
